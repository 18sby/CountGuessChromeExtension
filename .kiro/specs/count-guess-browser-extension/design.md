# 设计文档

## 概述

Count Guess是一款Chrome浏览器扩展插件，提供具有四个不同角色的互动计数游戏。该扩展采用纯前端实现，所有数据存储在本地IndexedDB中。用户通过点击角色按钮增加每日计数（每个角色最多300次），通过动画进度条查看进度，并可将历史数据导出为CSV文件。界面文本全部使用英文显示，采用人格化角色设计和颜色主题。

## 架构

### 高层架构

```
┌─────────────────────────────────────────┐
│         Chrome Extension                │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │      Popup UI (HTML/CSS)          │ │
│  │  - Character Buttons              │ │
│  │  - Progress Bars                  │ │
│  │  - Export Button                  │ │
│  │  - Export Reminder                │ │
│  └───────────┬───────────────────────┘ │
│              │                          │
│  ┌───────────▼───────────────────────┐ │
│  │   Application Logic (JS)          │ │
│  │  - Counter Management             │ │
│  │  - Animation Controller           │ │
│  │  - Daily Reset Handler            │ │
│  │  - CSV Export Generator           │ │
│  └───────────┬───────────────────────┘ │
│              │                          │
│  ┌───────────▼───────────────────────┐ │
│  │   Data Layer (IndexedDB)          │ │
│  │  - Current Counters               │ │
│  │  - Historical Records             │ │
│  │  - Export Reminder State          │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 技术栈

- **清单版本**: Chrome Extension Manifest V3
- **前端**: HTML5, CSS3, 原生JavaScript
- **存储**: IndexedDB（通过浏览器原生API）
- **动画**: CSS过渡和动画
- **构建**: 无需构建过程（纯前端）

### 设计理念

1. **纯前端架构**: 无需后端服务器，确保隐私保护和离线功能（需求6.5）
2. **IndexedDB存储**: 为时间序列数据提供结构化本地存储和良好性能（需求6.1-6.4）
3. **Manifest V3**: 最新的Chrome扩展标准，提供更好的安全性和性能（需求8.1）
4. **CSS动画**: 硬件加速的高性能动画，资源占用最小（需求7.4-7.5）

## 组件和接口

### 1. 角色按钮组件

**用途**: 每个角色的交互按钮，用于增加计数并显示动画

**属性**:
- `characterId`: 唯一标识符（sneezy-boom, stampy-sigh, grumble-gus, negative-ned）
- `label`: 英文显示名称
- `themeColor`: 主题颜色（红、蓝、绿、黄）
- `currentCount`: 当前每日计数（0-300）
- `isDisabled`: 布尔值，表示按钮是否禁用

**行为**:
- 点击处理器增加计数并触发缩放动画（需求2.1, 2.3）
- 计数达到300时禁用（需求2.4）
- 达到最大值时显示闪烁动画（需求2.5）
- 缩放动画持续时间：300毫秒（需求7.1）

**视觉设计**:
```
┌─────────────────────────┐
│   [角色图标]            │
│   角色名称              │
│   主题颜色边框          │
└─────────────────────────┘
```

### 2. 进度条组件

**用途**: 每个角色计数进度的可视化表示

**属性**:
- `characterId`: 关联的角色
- `currentCount`: 当前计数值
- `maxCount`: 最大计数（300）
- `themeColor`: 匹配角色的主题颜色
- `percentage`: 计算公式为（currentCount / 300）× 100%

**行为**:
- 计数变化时以平滑渐变过渡更新（需求3.2）
- 动画持续时间：300毫秒（需求7.2）
- 在进度条旁显示数字计数（需求3.5）
- 每日重置时以淡入淡出动画重置（需求4.3）

**视觉设计**:
```
角色名称: 150/300
[████████████░░░░░░░░░░░░] 50%
```

### 3. 每日重置管理器

**用途**: 处理午夜自动重置计数器

**职责**:
- 监控系统时间以检测午夜转换（需求4.1）
- 重置前将当天数据保存到历史记录（需求4.2）
- 将所有计数器重置为0（需求4.1）
- 触发淡出/淡入动画（持续500毫秒）（需求4.3, 7.3）
- 重新启用所有角色按钮（需求4.4）
- 确保打开弹窗时立即显示重置状态（需求4.5）

**实现策略**:
- 使用`setInterval`每分钟检查一次时间
- 将当前日期与存储的最后活动日期比较
- 日期变化时触发重置逻辑
- 使用后台脚本或service worker进行持久监控

### 4. CSV导出模块

**用途**: 生成并下载包含历史数据的CSV文件

**导出格式**:
```csv
Date,Sneezy Boom,Stampy Sigh,Grumble Gus,Negative Ned
2025-11-01,250,180,300,95
2025-11-02,200,220,275,150
```

**行为**:
- 导出按钮在弹窗UI中可见（需求5.1）
- 生成带有英文表头的CSV（需求5.3）
- 包含所有历史记录（需求5.4）
- 触发浏览器下载（需求5.5）
- 文件名格式：`count-guess-history-YYYY-MM-DD.csv`

### 5. 导出提醒系统

**用途**: 每月通知用户导出数据

**属性**:
- `isVisible`: 布尔值，表示提醒是否可见
- `displayStartDate`: 首次显示提醒的日期
- `dismissalReason`: 'exported'（已导出）或'timeout'（超时）

**行为**:
- 每月1号显示（需求5.6）
- 最多显示7天（需求5.7）
- 成功导出后关闭（需求5.8）
- 7天后自动关闭（需求5.9）

**视觉设计**:
```
┌─────────────────────────────────────┐
│ ⓘ 每月提醒：导出您的数据以保持      │
│    记录安全！                       │
│    [立即导出] [关闭]                │
└─────────────────────────────────────┘
```

## 数据模型

### IndexedDB架构

**数据库名称**: `CountGuessDB`
**版本**: 1

#### 对象存储: `dailyCounters`

存储当天的计数器值

```javascript
{
  id: 'current',
  date: '2025-11-18', // ISO日期字符串
  counters: {
    'sneezy-boom': 150,
    'stampy-sigh': 200,
    'grumble-gus': 300,
    'negative-ned': 75
  },
  lastUpdated: 1700352000000 // 时间戳
}
```

#### 对象存储: `historyRecords`

存储历史每日记录

```javascript
{
  date: '2025-11-17', // 主键，ISO日期字符串
  counters: {
    'sneezy-boom': 250,
    'stampy-sigh': 180,
    'grumble-gus': 300,
    'negative-ned': 95
  }
}
```

**索引**: `date`（唯一）

#### 对象存储: `appState`

存储应用状态，包括导出提醒

```javascript
{
  id: 'exportReminder',
  isVisible: true,
  displayStartDate: '2025-11-01',
  lastExportDate: '2025-10-15'
}
```

### 角色配置

```javascript
const CHARACTERS = [
  {
    id: 'sneezy-boom',
    label: 'Sneezy Boom',
    themeColor: '#E53E3E', // 红色
    icon: '💥'
  },
  {
    id: 'stampy-sigh',
    label: 'Stampy Sigh',
    themeColor: '#3182CE', // 蓝色
    icon: '😮‍💨'
  },
  {
    id: 'grumble-gus',
    label: 'Grumble Gus',
    themeColor: '#38A169', // 绿色
    icon: '😠'
  },
  {
    id: 'negative-ned',
    label: 'Negative Ned',
    themeColor: '#D69E2E', // 黄色
    icon: '😔'
  }
];

const MAX_DAILY_COUNT = 300;
```

## 错误处理

### IndexedDB错误

**场景**: 数据库连接失败或配额超限

**处理方式**:
- 在弹窗中显示用户友好的错误消息
- 对关键状态（当前计数器）回退到localStorage
- 将错误记录到控制台以便调试
- 如果检测到数据损坏，提供"重置数据"选项

### 导出错误

**场景**: CSV生成或下载失败

**处理方式**:
- 显示带有重试选项的错误通知
- 生成前验证数据
- 捕获并记录任何文件系统错误
- 提供替代方案：将CSV文本复制到剪贴板

### 每日重置错误

**场景**: 重置逻辑失败或错过午夜转换

**处理方式**:
- 每次打开弹窗时检查日期作为后备方案
- 实现幂等重置逻辑（可安全多次调用）
- 通过在重置前保存历史记录来保持数据完整性
- 记录重置事件以便调试

### 动画性能

**场景**: 低端设备上动画卡顿

**处理方式**:
- 谨慎使用`will-change` CSS属性
- 实现`prefers-reduced-motion`媒体查询支持
- 在设置中提供禁用动画的选项（未来增强）
- 如需要，使用`requestAnimationFrame`实现JavaScript动画

## 测试策略

### 单元测试

**计数器逻辑**:
- 测试递增功能（0到300）
- 测试边界条件（达到300时按钮禁用）
- 测试重置逻辑（计数器返回0）

**日期/时间逻辑**:
- 测试午夜检测
- 测试重置触发的日期比较
- 测试导出提醒日期计算（每月1号，7天窗口期）

**CSV生成**:
- 使用各种数据集测试CSV格式
- 测试空历史记录场景
- 测试数据中的特殊字符（如有）

### 集成测试

**IndexedDB操作**:
- 测试读/写操作
- 测试跨弹窗会话的数据持久化
- 测试迁移场景（未来版本）

**UI交互**:
- 测试按钮点击增加计数
- 测试进度条正确更新
- 测试导出按钮触发下载
- 测试提醒显示和关闭

### 手动测试

**视觉测试**:
- 验证角色按钮颜色与主题匹配（需求1.2-1.5）
- 验证动画流畅且性能良好（需求7.1-7.3）
- 验证进度条在各种百分比下正确显示
- 验证达到最大值按钮的闪烁动画（需求2.5）

**跨浏览器测试**:
- 在最新稳定版Chrome上测试（需求8.2）
- 测试不同尺寸下弹窗的响应性（需求8.3）
- 验证总包大小小于5MB（需求8.5）

**端到端场景**:
- 完整的每日周期：计数、达到最大值、午夜重置
- 导出数据并验证CSV内容
- 月度提醒流程：显示、导出、关闭
- 离线功能验证（需求6.5）

### 性能测试

**监控指标**:
- 弹窗加载时间（目标：< 100毫秒）
- 动画帧率（目标：60fps）
- IndexedDB查询时间（目标：< 50毫秒）
- 内存使用（目标：< 10MB）
- 包大小（要求：< 5MB）

**测试方法**:
- 使用Chrome DevTools性能分析器
- 使用大型历史数据集测试（1年以上）
- 监控动画期间的CPU使用率
- 在低端设备/机器上测试

## 实现说明

### 弹窗生命周期

1. **弹窗打开**:
   - 检查日期是否已更改（如需要则触发重置）
   - 从IndexedDB加载当前计数器
   - 使用当前状态渲染UI
   - 检查并显示导出提醒（如适用）

2. **用户交互**:
   - 处理按钮点击
   - 在内存和IndexedDB中更新计数器
   - 触发动画
   - 更新进度条

3. **弹窗关闭**:
   - 所有状态已持久化到IndexedDB
   - 无需清理

### 后台脚本考虑

虽然弹窗处理大部分逻辑，但后台service worker可能有助于：
- 在弹窗关闭时监控午夜转换
- 确保每日重置可靠发生
- 管理导出提醒状态

**权衡**: 增加复杂性但提高基于时间功能的可靠性

### 响应式设计

**弹窗尺寸**:
- 默认：400px宽 × 600px高
- 最小：320px宽 × 480px高
- 最大：800px宽 × 800px高

**布局策略**:
- 角色部分垂直堆叠
- 使用CSS Grid或Flexbox实现灵活间距
- 使用rem单位的可缩放字体大小
- 触摸友好的按钮尺寸（最小44×44px）

### 可访问性考虑

虽然没有明确要求，但应实现基本的可访问性：
- 语义化HTML元素
- 进度条的ARIA标签
- 键盘导航支持
- 足够的颜色对比度
- 交互元素的焦点指示器

### 未来增强功能（超出范围）

- 自定义设置面板
- 按钮点击音效
- 成就系统
- 跨设备数据同步
- 深色模式支持
- 英文以外的其他语言支持
